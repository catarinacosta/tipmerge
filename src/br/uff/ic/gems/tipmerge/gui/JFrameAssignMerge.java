/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package br.uff.ic.gems.tipmerge.gui;

import arch.Cell;
import arch.IMatrix2D;
import br.uff.ic.gems.tipmerge.dao.MergeCommitsDao;
import br.uff.ic.gems.tipmerge.model.Coverage;
import br.uff.ic.gems.tipmerge.model.EditedFile;
import br.uff.ic.gems.tipmerge.model.Medalist;
import br.uff.ic.gems.tipmerge.model.MergeCommits;
import br.uff.ic.gems.tipmerge.model.MergeFiles;
import br.uff.ic.gems.tipmerge.model.RankingGenerator;
import br.uff.ic.gems.tipmerge.model.Repository;
import dao.DominoesSQLDao2;
import domain.Dominoes;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.Icon;
import javax.swing.ImageIcon;
import javax.swing.JComboBox;
import javax.swing.JLabel;
import javax.swing.JTable;
import javax.swing.table.DefaultTableModel;

/**
 *
 * @author j2cf
 */
public class JFrameAssignMerge extends javax.swing.JFrame {

	private JTable jTableRanking = new JTable();
	private static String databaseName = "data/gitdataminer.sqlite";
	private static Repository repository;
	
	public JFrameAssignMerge(Repository repository) {
		initComponents();
		initVariables(repository);
	}
		
	public JFrameAssignMerge(Repository repository, MergeFiles mergeFiles, Map<EditedFile,Set<EditedFile>> dependenciesBranchOne, Map<EditedFile,Set<EditedFile>> dependenciesBranchTwo) {
		initComponents();
		this.repository = repository;
		initVariables(repository);
		mergesList.setModel(new JComboBox(new String[]{mergeFiles.getHash()}).getModel());

		System.out.println("Medals for common files");
		RankingGenerator rGenerator = new RankingGenerator();
		Set<EditedFile> excepiontFiles = rGenerator.setMedalsFilesEditedBothBranches(mergeFiles);
		System.out.println("Medals for dependencies in branch 1");
		excepiontFiles = rGenerator.setMedalFromDependencies(dependenciesBranchOne, mergeFiles, excepiontFiles);
		System.out.println("Medals for dependencies in branch 2");
		excepiontFiles = rGenerator.setMedalFromDependencies(dependenciesBranchTwo, mergeFiles, excepiontFiles);
		excepiontFiles.removeAll(excepiontFiles);
		List<Medalist> ranking = rGenerator.getRanking();
		showRanking(ranking);
	}

	/**
	 * This method is called from within the constructor to initialize the form.
	 * WARNING: Do NOT modify this code. The content of this method is always
	 * regenerated by the Form Editor.
	 */
	@SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel4 = new javax.swing.JPanel();
        jLabel13 = new javax.swing.JLabel();
        btRunCoverage = new javax.swing.JButton();
        txProjectName = new javax.swing.JTextField();
        jLabel14 = new javax.swing.JLabel();
        mergesList = new javax.swing.JComboBox();
        labelLoading = new javax.swing.JLabel();
        paneResult = new javax.swing.JSplitPane();
        panelRanking = new javax.swing.JScrollPane();
        panelCoverage = new javax.swing.JScrollPane();
        txtCoverage = new javax.swing.JTextArea();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("Developer Assignments");

        jPanel4.setBorder(javax.swing.BorderFactory.createEtchedBorder());

        jLabel13.setText("Repository Name");

        btRunCoverage.setText("Coverage");
        btRunCoverage.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btRunCoverageActionPerformed(evt);
            }
        });

        jLabel14.setText("Selected Merge");

        mergesList.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                mergesListActionPerformed(evt);
            }
        });

        labelLoading.setIcon(new javax.swing.ImageIcon(getClass().getResource("/br/uff/ic/gems/tipmerge/icons/loading1.gif"))); // NOI18N
        labelLoading.setText("Loading ...");
        labelLoading.setVisible(false);

        javax.swing.GroupLayout jPanel4Layout = new javax.swing.GroupLayout(jPanel4);
        jPanel4.setLayout(jPanel4Layout);
        jPanel4Layout.setHorizontalGroup(
            jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel4Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel4Layout.createSequentialGroup()
                        .addComponent(labelLoading, javax.swing.GroupLayout.PREFERRED_SIZE, 110, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addComponent(btRunCoverage, javax.swing.GroupLayout.PREFERRED_SIZE, 86, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(jPanel4Layout.createSequentialGroup()
                        .addGroup(jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jLabel13)
                            .addComponent(jLabel14))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(mergesList, 0, 517, Short.MAX_VALUE)
                            .addComponent(txProjectName))))
                .addContainerGap())
        );
        jPanel4Layout.setVerticalGroup(
            jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel4Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel13)
                    .addComponent(txProjectName, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel14)
                    .addComponent(mergesList, javax.swing.GroupLayout.PREFERRED_SIZE, 22, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 26, Short.MAX_VALUE)
                .addGroup(jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btRunCoverage)
                    .addComponent(labelLoading))
                .addContainerGap())
        );

        paneResult.setBorder(javax.swing.BorderFactory.createEtchedBorder());
        paneResult.setDividerSize(10);
        paneResult.setOrientation(javax.swing.JSplitPane.VERTICAL_SPLIT);
        paneResult.setResizeWeight(0.4);
        paneResult.setToolTipText("");
        paneResult.setMinimumSize(new java.awt.Dimension(115, 143));
        paneResult.setPreferredSize(new java.awt.Dimension(154, 152));

        panelRanking.setBorder(javax.swing.BorderFactory.createTitledBorder("Ranking"));
        paneResult.setLeftComponent(panelRanking);

        panelCoverage.setBorder(javax.swing.BorderFactory.createTitledBorder("Coverage"));

        txtCoverage.setColumns(20);
        txtCoverage.setRows(5);
        txtCoverage.setText("Coverage datas");
        panelCoverage.setViewportView(txtCoverage);

        paneResult.setRightComponent(panelCoverage);

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jPanel4, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addComponent(paneResult, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(jPanel4, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(paneResult, javax.swing.GroupLayout.DEFAULT_SIZE, 337, Short.MAX_VALUE))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void btRunCoverageActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btRunCoverageActionPerformed

		Runnable r;
		r = new Runnable() {

			public void run() {
				labelLoading.setVisible(true);
				
				MergeCommitsDao mCommitsDao = new MergeCommitsDao(repository.getProject());
				MergeCommits merge = new MergeCommits(mergesList.getSelectedItem().toString().split(" ")[0], repository.getProject());
				mCommitsDao.update(merge);
				
				List<String> hashsList = mCommitsDao.getHashs(merge.getHashBase(), merge.getParents()[0]);
				hashsList.addAll(mCommitsDao.getHashs(merge.getHashBase(), merge.getParents()[1]));
				
				try {
					
					List<Dominoes> dominoesList = DominoesSQLDao2.loadAllMatrices(databaseName, txProjectName.getText(), "CPU", hashsList);
					
					int cols, rows;
					Dominoes dominoesDC = null, dominoesCM = null, dominoesFM = null;
					for(Dominoes dominoe : dominoesList){
						if(dominoe.getHistoric().toString().equals("DC"))
							dominoesDC = dominoe;
						if(dominoe.getHistoric().toString().equals("CM"))
							dominoesCM = dominoe;
						if (dominoe.getHistoric().toString().equals("FM"))
							dominoesFM = dominoe;
					}
					
					List<String[]> files = getFilesList(dominoesFM);
					
					//get wich developers edited methods
					Dominoes dominoesDM = dominoesDC.multiply(dominoesCM);
					
					List<Coverage> coverageList = getCoverageList(dominoesDM, files);
					
					Map<String, Integer[]> fileNames = countsEditedMethods(files);
					
					appendCoverageToGui(files, coverageList, fileNames);

					
				} catch (SQLException ex) {
					Logger.getLogger(JFrameAssignMerge.class.getName()).log(Level.SEVERE, null, ex);
				} catch (Exception ex) {
					Logger.getLogger(JFrameAssignMerge.class.getName()).log(Level.SEVERE, null, ex);
				}
				
				labelLoading.setVisible(false);
			}

			private List<String[]> getFilesList(Dominoes dominoesFM) {
				int cols;
				IMatrix2D matrixFM = dominoesFM.getMat();
				cols = matrixFM.getMatrixDescriptor().getNumCols();
				List<String[]> files = new ArrayList<>();
				for(int i = 0 ; i < cols ; i++){
					int j = 0;
					String[] file = dominoesFM.getMat().getMatrixDescriptor().getColumnAt(i).split("\\$", 2);
					while((j < files.size()) && (files.get(j)[0].compareTo(file[0]) < 0))
						j++;
					files.add(j,dominoesFM.getMat().getMatrixDescriptor().getColumnAt(i).split("\\$", 2));
				}
				return files;
			}

			private List<Coverage> getCoverageList(Dominoes dominoesDM, List<String[]> files) {
				int rows;
				int cols;
				IMatrix2D matrixDM = dominoesDM.getMat();
				rows = matrixDM.getMatrixDescriptor().getNumRows();
				cols = matrixDM.getMatrixDescriptor().getNumCols();
				List<Cell> cells = matrixDM.getNonZeroData();
				List<Coverage> coverageList = new ArrayList<>();
				for(int i = 0 ; i < rows ; i++){
					
					Coverage coverage = new Coverage();
					coverage.setDeveloper(matrixDM.getMatrixDescriptor().getRowAt(i));
					
					for(int j = 0 ; j < cols ; j++){
						
						for(Cell c : cells)
							if((c.row == i) && (c.col == j)){
								
								for(String[] fullName : files)
									if(fullName[1].equals(matrixDM.getMatrixDescriptor().getColumnAt(j)))
										coverage.addValue(fullName);
								
							}
						
					}
					coverageList.add(coverage);
					
				}
				return coverageList;
			}

			private void appendCoverageToGui(List<String[]> files, List<Coverage> coverageList, Map<String, Integer[]> fileNames) {
				txtCoverage.setText("+-------- Files and Methods ---------+");
				files.stream().forEach((file) -> {
					txtCoverage.append("\n\t" + Arrays.toString(file));
				});
				
				txtCoverage.append("\n\n+-------- Coverage Sumary ---------+");
				for(Coverage coverage : coverageList){
					txtCoverage.append("\n" + coverage.getDeveloper());
					Map<String, Integer[]> cover = coverage.getCoverage(fileNames);
					for(String file : cover.keySet())
						txtCoverage.append("\n\t" + file + "\t" + Arrays.toString(cover.get(file)));
				}
				
				
				txtCoverage.append("\n\n+-------- Coverage Files ---------+");
				for(Coverage coverage : coverageList)
					txtCoverage.append(coverage.toString());
			}

			private Map<String, Integer[]> countsEditedMethods(List<String[]> files) {
				Map<String, Integer[]> fileNames = new HashMap<>();
				int totalMethodsFile = 0;
				String fileName = "";
				for(String[] fullFileName : files){
					if(!fileName.equals(fullFileName[0])){
						if (!fileName.isEmpty())
							fileNames.put(fileName, new Integer[]{totalMethodsFile});
						fileName = fullFileName[0];
						totalMethodsFile = 1;
					}else
						totalMethodsFile++;
				}
				fileNames.put(fileName, new Integer[]{totalMethodsFile});
				return fileNames;
			}
		};
		Thread t = new Thread(r);
		t.start();
			
    }//GEN-LAST:event_btRunCoverageActionPerformed

    private void mergesListActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_mergesListActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_mergesListActionPerformed


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btRunCoverage;
    private javax.swing.JLabel jLabel13;
    private javax.swing.JLabel jLabel14;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JLabel labelLoading;
    private javax.swing.JComboBox mergesList;
    private javax.swing.JSplitPane paneResult;
    private javax.swing.JScrollPane panelCoverage;
    private javax.swing.JScrollPane panelRanking;
    private javax.swing.JTextField txProjectName;
    private javax.swing.JTextArea txtCoverage;
    // End of variables declaration//GEN-END:variables

	private void showRanking(List<Medalist> ranking) {
		DefaultTableModel model = new DefaultTableModel();
		Icon mGold = new ImageIcon(getClass().getResource("/br/uff/ic/gems/tipmerge/icons/gold1.png"));
		Icon mSilver = new ImageIcon(getClass().getResource("/br/uff/ic/gems/tipmerge/icons/silver1.png"));
		Icon mBronze = new ImageIcon(getClass().getResource("/br/uff/ic/gems/tipmerge/icons/bronze1.png"));
		JLabel lblGold = new JLabel("Gold");
		JLabel lblSilver = new JLabel("Silver");
		JLabel lblBronze = new JLabel("Bronze");
		lblGold.setIcon(mGold);
		lblSilver.setIcon(mSilver);
		lblBronze.setIcon(mBronze);
		String[] columnLabels = {"Ranking", "Committer", "Gold", "Silver", "Bronze", "Total"};
		model.setColumnIdentifiers(columnLabels);
		
		int rank = 1;
		for(Medalist m : ranking){
			int gold = m.getGoldMedals();
			int silver = m.getSilverMedals();
			int bronze = m.getBronzeMedals();
			int total = gold + silver + bronze;
			String name = m.getCommitter().getName();
			model.addRow(new Object[]{rank++ + "º", name, gold, silver, bronze, total});
		}
		jTableRanking.setModel(model);
		JTableRenderer jTableRender = new JTableRenderer();
		jTableRanking.getColumnModel().getColumn(2).setHeaderValue(lblGold);
		jTableRanking.getColumnModel().getColumn(2).setHeaderRenderer(jTableRender);
		jTableRanking.getColumnModel().getColumn(3).setHeaderValue(lblSilver);
		jTableRanking.getColumnModel().getColumn(3).setHeaderRenderer(jTableRender);
		jTableRanking.getColumnModel().getColumn(4).setHeaderValue(lblBronze);
		jTableRanking.getColumnModel().getColumn(4).setHeaderRenderer(jTableRender);
		jTableRanking.setDefaultRenderer(Object.class,new JTableRenderer());
		panelRanking.setViewportView(jTableRanking);
	}

	private void initVariables(Repository repository) {
		this.txProjectName.setText(repository.getName());	
		mergesList.setModel(new JComboBox(repository.getListOfMerges().toArray()).getModel());
	}

}
